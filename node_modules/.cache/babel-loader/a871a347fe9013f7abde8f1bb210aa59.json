{"ast":null,"code":"\"use strict\"; // Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.RxWebSocket = exports.ConnectionState = void 0;\n\nconst rxjs_1 = require(\"rxjs\");\n\nconst operators_1 = require(\"rxjs/operators\");\n\nvar ConnectionState;\n\n(function (ConnectionState) {\n  ConnectionState[ConnectionState[\"DISCONNECTED\"] = 0] = \"DISCONNECTED\";\n  ConnectionState[ConnectionState[\"CONNECTING\"] = 1] = \"CONNECTING\";\n  ConnectionState[ConnectionState[\"CONNECTED\"] = 2] = \"CONNECTED\";\n})(ConnectionState = exports.ConnectionState || (exports.ConnectionState = {}));\n/**\n * Rx-ified WebSocket\n */\n\n\nclass RxWebSocket {\n  /**\n   * Constructor\n   * @param url WebSocket server URL\n   * @param [WebSocketClass] Custom WebSocket implementation\n   */\n  constructor(url, WebSocketClass = WebSocket) {\n    this.WebSocketClass = WebSocketClass;\n    this.webSocket = null;\n    this.connectionStateSubject = new rxjs_1.BehaviorSubject(ConnectionState.DISCONNECTED);\n    this.incomingDataSubject = new rxjs_1.Subject();\n    this.url = url.replace(/^http/, \"ws\");\n  }\n  /**\n   * Make a websocket connection\n   * @returns an Observable that completes when connected\n   */\n\n\n  connect() {\n    if (this.webSocket) {\n      return rxjs_1.throwError(new Error(\"webSocket object is not null\"));\n    }\n\n    return new rxjs_1.Observable(obs => {\n      let webSocket;\n\n      try {\n        this.webSocket = webSocket = new this.WebSocketClass(this.url);\n      } catch (err) {\n        obs.error(err);\n        return;\n      }\n\n      this.connectionStateSubject.next(ConnectionState.CONNECTING);\n\n      webSocket.onclose = evt => {\n        this.clearWebSocket();\n        obs.error(new Error(`websocket error ${evt.code}: ${evt.reason}`));\n        this.connectionStateSubject.next(ConnectionState.DISCONNECTED);\n      };\n\n      webSocket.onopen = _ => {\n        obs.next();\n        obs.complete();\n        this.connectionStateSubject.next(ConnectionState.CONNECTED);\n      };\n\n      webSocket.onmessage = evt => {\n        this.incomingDataSubject.next(evt.data);\n      };\n    }).pipe(operators_1.take(1));\n  }\n  /**\n   * Disconnect from server\n   */\n\n\n  disconnect() {\n    const {\n      webSocket\n    } = this;\n\n    if (!webSocket) {\n      return;\n    }\n\n    this.clearWebSocket();\n    this.connectionStateSubject.next(ConnectionState.DISCONNECTED);\n\n    try {\n      webSocket.close();\n    } catch (_a) {}\n  }\n  /**\n   * Emit current connection state and subsequent changes\n   * @returns an Observable for the connection state\n   */\n\n\n  get connectionState$() {\n    return this.connectionStateSubject.asObservable();\n  }\n  /**\n   * Emit incoming data from server\n   * @returns an Observable for the data received\n   */\n\n\n  get incomingData$() {\n    return this.incomingDataSubject.asObservable();\n  }\n  /**\n   * Emit incoming JSON data from server. non-JSON data are ignored\n   * @returns an Observable for parsed JSON data\n   */\n\n\n  get incomingJSONData$() {\n    return this.incomingData$.pipe(operators_1.flatMap(m => {\n      let j;\n\n      try {\n        j = JSON.parse(m);\n      } catch (err) {\n        return rxjs_1.empty();\n      }\n\n      return rxjs_1.of(j);\n    }));\n  }\n  /**\n   * Send data to server\n   * @param data text to send\n   */\n\n\n  sendData(data) {\n    const {\n      webSocket\n    } = this;\n\n    if (!webSocket) {\n      throw new Error(\"websocket is not connected\");\n    }\n\n    webSocket.send(data);\n  }\n\n  clearWebSocket() {\n    const {\n      webSocket\n    } = this;\n\n    if (!webSocket) {\n      return;\n    }\n\n    this.webSocket = null;\n    webSocket.onclose = null;\n    webSocket.onerror = null;\n    webSocket.onmessage = null;\n    webSocket.onopen = null;\n  }\n\n}\n\nexports.RxWebSocket = RxWebSocket;","map":null,"metadata":{},"sourceType":"script"}