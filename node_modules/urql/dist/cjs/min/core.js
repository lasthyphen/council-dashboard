"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./index-dddbd19e.js"),t=require("wonka"),r=require("graphql"),n=function(e){var t=e.operationName;return"subscription"!==t&&"query"!==t};function o(e){return""+e}var i=function(e){var t=e.operationName;return"mutation"!==t&&"query"!==t};function a(t){return e._extends(e._extends({},t),{query:e.formatDocument(t.query)})}function u(t){return e.addMetadata(t,{cacheOutcome:"miss"})}function c(e){return i(e)}var s=function(r){var n=r.forward,o=r.client,s=new Map,d=Object.create(null),h=a,x=p(s,d,o),v=l(s,d),m=function(e){var t=e.context.requestPolicy;return"query"===e.operationName&&"network-only"!==t&&("cache-only"===t||s.has(e.key))};function y(t){var r=s.get(t.key),n=e._extends(e._extends({},r),{operation:e.addMetadata(t,{cacheOutcome:r?"hit":"miss"})});return"cache-and-network"===t.context.requestPolicy&&(n.stale=!0,f(o,t)),n}function k(e){return!i(e)&&m(e)}function O(e){e.operation&&"mutation"===e.operation.operationName?x(e):e.operation&&"query"===e.operation.operationName&&v(e)}function q(e){return!i(e)&&!m(e)}return function(e){var r=t.share(e),o=t.map(y)(t.filter(k)(r)),i=t.tap(O)(n(t.map(u)(t.merge([t.map(h)(t.filter(q)(r)),t.filter(c)(r)]))));return t.merge([o,i])}},f=function(t,r){return t.reexecuteOperation(e._extends(e._extends({},r),{context:e._extends(e._extends({},r.context),{requestPolicy:"network-only"})}))},p=function(t,r,n){function o(e){if(t.has(e)){var r=t.get(e).operation;t.delete(e),f(n,r)}}return function(t){var n=new Set;function i(e){n.add(e)}e.collectTypesFromResponse(t.data).forEach(function(e){var t=r[e]||(r[e]=new Set);t.forEach(i),t.clear()}),n.forEach(o)}},l=function(t,r){return function(n){var o=n.operation,i=n.data;null!=i&&(t.set(o.key,{operation:o,data:i,error:n.error}),e.collectTypesFromResponse(n.data).forEach(function(e){(r[e]||(r[e]=new Set)).add(o.key)}))}},d=function(e){return"subscription"===e.operationName};function h(e){return!d(e)}var x=function(e){var r=e.forward,n=new Set,o=function(e){var t=e.key,r=e.operationName;if("teardown"===r)return n.delete(t),!0;if("query"!==r&&"subscription"!==r)return!0;var o=n.has(t);return n.add(t),!o},i=function(e){n.delete(e.operation.key)};return function(e){var n=t.filter(o)(e);return t.tap(i)(r(n))}};function v(e){var t=e.operationName;return"query"===t||"mutation"===t}var m=function(e){var r=e.forward,n=v;function o(e){return!n(e)}return function(e){var i=t.share(e),a=t.mergeMap(function(e){var r=e.key,n=t.filter(function(e){return"teardown"===e.operationName&&e.key===r})(i);return t.takeUntil(n)(k(e))})(t.filter(n)(i)),u=r(t.filter(o)(i));return t.merge([a,u])}};function y(e){return e.kind===r.Kind.OPERATION_DEFINITION&&e.name}var k=function(n){return t.make(function(t){var o,i=t.next,a=t.complete,u="undefined"!=typeof AbortController?new AbortController:void 0,c=n.context,s="function"==typeof c.fetchOptions?c.fetchOptions():c.fetchOptions||{},f=void 0!==(o=n.query.definitions.find(y))&&o.name?o.name.value:null,p={query:r.print(n.query),variables:n.variables};null!==f&&(p.operationName=f);var l=e._extends(e._extends({body:JSON.stringify(p),method:"POST"},s),{headers:e._extends({"content-type":"application/json"},s.headers),signal:void 0!==u?u.signal:void 0});return O(n,l).then(function(e){void 0!==e&&i(e),a()}),function(){void 0!==u&&u.abort()}})},O=function(t,r){var n,o=t.context;return(o.fetch||fetch)(o.url,r).then(function(e){var t=e.status;if(n=e,t<200||t>=("manual"===r.redirect?400:300))throw new Error(e.statusText);return e.json()}).then(function(r){return e.makeResult(t,r,n)}).catch(function(r){if("AbortError"!==r.name)return e.makeErrorResult(t,r,n)})};function q(){return!1}function w(e){}var b=function(e){return t.filter(q)(t.tap(w)(e))},g=function(e){return 1===e.length?e[0]:function(t){return e.reduceRight(function(e,r){return r({client:t.client,forward:e})},t.forward)}},E=[x,s,m],_=function(r){var n=this;this.activeOperations=Object.create(null),this.createOperationContext=function(t){return e._extends(e._extends({url:n.url,fetchOptions:n.fetchOptions,fetch:n.fetch},t),{requestPolicy:(t||{}).requestPolicy||n.requestPolicy})},this.createRequestOperation=function(e,t,r){return{key:t.key,query:t.query,variables:t.variables,operationName:e,context:n.createOperationContext(r)}},this.reexecuteOperation=function(e){(n.activeOperations[e.key]||0)>0&&n.dispatchOperation(e)},this.executeQuery=function(e,r){var o=n.createRequestOperation("query",e,r),i=n.executeRequestOperation(o),a=o.context.pollInterval;return a?t.switchMap(function(){return i})(t.merge([t.fromValue(0),t.interval(a)])):i},this.executeSubscription=function(e,t){var r=n.createRequestOperation("subscription",e,t);return n.executeRequestOperation(r)},this.executeMutation=function(e,t){var r=n.createRequestOperation("mutation",e,t);return n.executeRequestOperation(r)},this.url=r.url,this.fetchOptions=r.fetchOptions,this.fetch=r.fetch,this.suspense=!!r.suspense,this.requestPolicy=r.requestPolicy||"cache-first";var o=t.makeSubject(),i=o.next;this.operations$=o.source;var a=[],u=!1;this.dispatchOperation=function(e){if(a.push(e),!u){var t;for(u=!0;void 0!==(t=a.shift());)i(t);u=!1}},this.exchange=g(void 0!==r.exchanges?r.exchanges:E),this.results$=t.share(this.exchange({client:this,forward:b})(this.operations$)),t.publish(this.results$)};_.prototype.onOperationStart=function(e){var t=e.key;this.activeOperations[t]=(this.activeOperations[t]||0)+1,this.dispatchOperation(e)},_.prototype.onOperationEnd=function(t){var r=t.key,n=this.activeOperations[r]||0;(this.activeOperations[r]=n<=0?0:n-1)<=0&&this.dispatchOperation(e._extends(e._extends({},t),{operationName:"teardown"}))},_.prototype.executeRequestOperation=function(r){var n=this,o=r.key,i=r.operationName,a=t.filter(function(e){return e.operation.key===o})(this.results$);if("mutation"===i)return t.take(1)(t.onStart(function(){return n.dispatchOperation(r)})(a));var u=t.filter(function(e){return"teardown"===e.operationName&&e.key===o})(this.operations$),c=t.onEnd(function(){n.onOperationEnd(r)})(t.onStart(function(){n.onOperationStart(r)})(t.takeUntil(u)(a)));return!1!==r.context.suspense&&this.suspense&&"query"===i?e.toSuspenseSource(c):c},_.prototype.query=function(t,r,n){return n&&"boolean"==typeof n.suspense||(n=e._extends(e._extends({},n),{suspense:!1})),e.withPromise(this.executeQuery(e.createRequest(t,r),n))},_.prototype.mutation=function(t,r,n){return e.withPromise(this.executeMutation(e.createRequest(t,r),n))},exports.CombinedError=e.CombinedError,exports.createRequest=e.createRequest,exports.formatDocument=e.formatDocument,exports.makeErrorResult=e.makeErrorResult,exports.makeResult=e.makeResult,exports.stringifyVariables=e.stringifyVariables,exports.Client=_,exports.cacheExchange=s,exports.composeExchanges=g,exports.createClient=function(e){return new _(e)},exports.debugExchange=function(e){var t=e.forward;return function(e){return t(e)}},exports.dedupExchange=x,exports.defaultExchanges=E,exports.fallbackExchangeIO=b,exports.fetchExchange=m,exports.ssrExchange=function(r){var i={},a=function(e){return!n(e)&&void 0!==i[e.key]};function u(e){return!a(e)}function c(t){var r,n,o;return o={operation:t,data:(r=i[t.key]).data,extensions:void 0,error:void 0},void 0!==(n=r.error)&&(o.error=new e.CombinedError({networkError:new Error(n.networkError),graphQLErrors:n.graphQLErrors})),o}function s(e){return a(e)}function f(e){var t=e.operation;if(!n(t)){var r=function(e){var t=e.error,r={data:e.data,error:void 0};return void 0!==t&&(r.error={networkError:""+t.networkError,graphQLErrors:t.graphQLErrors.map(o)}),r}(e);i[t.key]=r}}function p(e){delete i[e.operation.key]}var l=function(e){var n=e.client,o=e.forward;return function(e){var i=r&&"boolean"==typeof r.isClient?!!r.isClient:!n.suspense,a=t.share(e),l=o(t.filter(u)(a)),d=t.map(c)(t.filter(s)(a));return i?d=t.tap(p)(d):l=t.tap(f)(l),t.merge([l,d])}};return l.restoreData=function(t){return e._extends(i,t)},l.extractData=function(){return e._extends({},i)},r&&r.initialState&&l.restoreData(r.initialState),l},exports.subscriptionExchange=function(n){var o=n.forwardSubscription;return function(n){var i=n.client,a=n.forward;return function(n){var u=t.share(n),c=t.mergeMap(function(n){var a=n.key,c=t.filter(function(e){return"teardown"===e.operationName&&e.key===a})(u);return t.takeUntil(c)(function(n){var a=o({key:n.key.toString(36),query:r.print(n.query),variables:n.variables,context:e._extends({},n.context)});return t.make(function(t){var r=t.next,o=t.complete,u=!1,c=a.subscribe({next:function(t){return r(e.makeResult(n,t))},error:function(t){return r(e.makeErrorResult(n,t))},complete:function(){u||i.reexecuteOperation(e._extends(e._extends({},n),{operationName:"teardown"})),o()}});return function(){u=!0,c.unsubscribe()}})}(n))})(t.filter(d)(u)),s=a(t.filter(h)(u));return t.merge([c,s])}}};